import { createAction } from '@babbage/sdk'
import pushdrop from 'pushdrop'
import constants from './constants'
import getFileUploadInfo from './getFileUploadInfo'
import submitPaymentProof from './submitPaymentProof'
import publishKey from './publishKey'
import { Authrite } from 'authrite-js'

export default async (
  song, retentionPeriod
) => {
  // Update the selected files
  const fileUploadInfo = await getFileUploadInfo({ selectedArtwork: song.selectedArtwork, selectedMusic: song.selectedMusic, retentionPeriod })
  
  // Create an action script based on the tsp-protocol
  const bitcoinOutputScript = await pushdrop.create({
    fields: [
      Buffer.from(constants.tempoTopic, 'utf8'), // Protocol Namespace Address
      Buffer.from(constants.tspProtocolID, 'utf8'),
      Buffer.from(song.title, 'utf8'),
      Buffer.from(song.artist, 'utf8'),
      Buffer.from('Default description', 'utf8'), // TODO: Add to UI
      Buffer.from('' + fileUploadInfo.songDuration, 'utf8'), // Duration
      //Buffer.from(fileUploadInfo.songURL, 'utf8'),
      Buffer.from('XUTxu4GrsRxqYCFAznPYz2zAubL3PKhaFYGVLXq7UEZV5GUpkxyb', 'utf8'), //added for testing
      Buffer.from(fileUploadInfo.artworkFileURL, 'utf8'),
      Buffer.from(Buffer.from(require('crypto').randomBytes(32)).toString('hex')) // Generate a unique songID
    ],
    protocolID: [2, 'tempo'],
    keyID: '1'
  })
  // Create an action for all outputs
  const actionData = {
    outputs: [{
      satoshis: 1,
      script: bitcoinOutputScript
    }, ...fileUploadInfo.outputs],
    description: 'Publish a song',
    //topics: [constants.tempoTopic] commented out for local dev
  }
  //const payment = await createAction(actionData)
  const payment = {"rawTx":"01000000027dd1e2082a4ced296c506def8c3b9e1235cd7453f22a6a03112a0df441677a18050000006b483045022100afa51ad191f26831877fefce7dde953b3f8ffed5c43619e43cd2f5b8aaeb4d4d02207c1336ec0e737740f4edff2e90d37fc4ea5d93da0c8815e0c9821c1d5e2a8c5c412103434f25b3629b2e21a0790081d0b95d8e86a15438f4c3b6fd2013ea14056edabbffffffffabd8d8ad015f12abe643ee9ba28f7e45a006aa020d77c140929b49cfa893cb6a040000006a473044022034d73201028cd755d33cbc7f18a16682b9c3f49b1e7dce9c850a4fcd89b4a7e20220791f75c35cb616220fbcd8d970baf96567dbbbed31d1ceb29b59d397b42df5c541210321f8011eff4ab34656683a7146f2b0f6d8a783e1cb35d5c70587dd8e55f4f35bffffffff070100000000000000fd5c012102ebec739c4b7ad1bd584e727b32126f5b6be87cd1e0e02a9cf23b5c34101593caac0354535022314c51744b4b4b376331544e33556352667370385371476a57747a47736b7a6533360174016a1344656661756c74206465736372697074696f6e013534585554787534477273527871594346417a6e50597a327a4175624c33504b6861465947564c58713755455a56354755706b787962345855543163714d3336613941443659585148657631727176566b574e347a50504e43794743706457476a6d6459724875614341724063346235636561636261653531373537336230363031636631333630396335323335343131386430323530303832373761633833346663633438326638616265473045022100d38ea7df1655b734e78eedc3ce817afd4bcf5e8c98d626ce6eeb391598ccafb302202b9268309151b36be71a6f34cbd87a8d887965f86976a7644636edfeec9d4dbc6d6d6d6d6d130c0000000000001976a914e86a9916117676337ee4e2ba3d6c63827a99f5e588ac22020000000000001976a914c90413bab0cfc700607c141c30e234d8ac40e07a88acc8000000000000001976a914917d2352c38eb8ce9621c388eec5c037492e5bd188ace7420000000000001976a9149b0a9e040e4c9b820e7fadbe94772aafcd60b44288ac7b040000000000001976a914e5d686326024f438af4b645dc63980d0d81f8add88ac8a080000000000001976a91491eb17b8d22f69a9bcc3f44a23ae775f76c881cc88ac00000000","inputs":{"187a6741f40d2a11036a2af25374cd35129e3b8cef6d506c29ed4c2a08e2d17d":{"inputs":{"f29f821f9024050ee37198a2a7ace0f63b3a82fd624251d354e4fe40db00c9da":{"rawTx":"0100000001be33ddf7f0d7bec627c76fc7019dee22e00eee115534be77ef027b56e57949e7040000006b483045022100fb258af2adc5cec6dbaebf91ef52879d325beb961b11ea9bd07d64c74097faeb02201f4aac88923207a9175647f554d743cad026f11101749bc99f666c0e4bd63041412102c322569e36c88eb8a51cb6896a3970e406fb29e8d721f736f4ee0fd0b613b47affffffff04f401000000000000fd1f022102afa2e315cb45322ff500d5d7a8a363cc20500642a47c2226155205574fad4589ac22313852713463583334356b6a7461734467764b41455a435135564c5a72516f76786d203eae870255ded2244512082da9364a0ac0eea5fc26054ab58f352e001c708a8d20b02c6c671977298321b1bfcfb8ce20418f23899f206d2be079d3b1acce30adde49bfe74a4591b912c3fe63a67882a6f1c1b8eec1e93319e2da62f17b08b48fcf267389850cb15165dd09f58804026d015edd82cb7790ca210485a169dfebee59a4eeb151bde541577e594c7f530c7b6d6c895ef2f91a2798186cc8fe4328ab1b5cb98368d4b63886564c0efd312d852fcf599f9de7c0c3a5fadf4ba4191e3e15b7aad782f2400afe8372f726b4ba833ceec258456448d28ca1fc4b059a94095745f108682c40ed90229c8ae8e037eff523c0a364a54a8778e4990f4764ce51b56f4c56aaa16bcfe735a7770a323432313630343834344c74064d4d5ad5cb2294df1b6b767c4f5a8900ad8be69237bdc615d32bf547fbbaa35813d64fde66fa48c68838eb9403eb5bceff57ed2e951117f8f3f2fe3697a9637d1651b9517c2698aa5578d925821fe0dc1a9a273a0eaaf6fc5c78a73b62293ff28b3b081ba09ff978cbb48077d7d8636796054f463044022032a886d2c60968b54f5d9cd7275c20d38eee971097f8bd58c40c25076d5ab3b50220118234704be9c08d62fab7e9e9fe0e86261a3864a99e1d1e3419e2537c1944346d6d6d6dc8000000000000001976a91461623d1ad01e4d46afd826fbed32498630c7ce2788ac540e0000000000001976a914e587d9bd80723e6e2d200fb07d6f62b24619fc3b88acf40a0000000000001976a914837966872f4a9bd2b93f7bac1a9b4d65a1ca866b88ac00000000","mapiResponses":[{"publicKey":"030d1fe5c1b560efe196ba40540ce9017c20daa9504c4c4cec6184fc702d9f274e","payload":"{\"apiVersion\":\"1.5.0\",\"timestamp\":\"2023-04-26T17:28:59.4875297Z\",\"txid\":\"f29f821f9024050ee37198a2a7ace0f63b3a82fd624251d354e4fe40db00c9da\",\"returnResult\":\"success\",\"resultDescription\":\"\",\"minerId\":\"030d1fe5c1b560efe196ba40540ce9017c20daa9504c4c4cec6184fc702d9f274e\",\"currentHighestBlockHash\":\"00000000000003e7cb6637c91a619086b7d4f09aa5d50f5fe5e676ceff70e638\",\"currentHighestBlockHeight\":1548904,\"txSecondMempoolExpiry\":0,\"warnings\":[],\"failureRetryable\":false}","signature":"30440220762a1e9037a5bc1c6a3a1c1d7fb9fcab45520ce88e7b5b4a6728584c6763484202204e7736962daf77ab31678669800d27e70bb136724c29e7015525b62173ddefaf"}],"inputs":{"e74979e5567b02ef77be345511ee0ee022ee9d01c76fc727c6bed7f0f7dd33be":{"rawTx":"01000000010a20d328889a9418845bfccb488563e2fb6d51915592e65bdb4358d3f07ca145060000006b483045022100871b3922aecad666b294bbc8f67aa19ab52dbc2c53317352059ff9c00a655808022012a6bac36411a850a51fb8f8f042bfa315c8d496c4ce6aee5c4821b1e236a60d412103ea21d3e51bb71bda64c7848840632dcb4649248cb9d991747e6135a582748de7ffffffff050100000000000000fd39012102ebec739c4b7ad1bd584e727b32126f5b6be87cd1e0e02a9cf23b5c34101593caac035453500174016a1344656661756c74206465736372697074696f6e01353458555377707a7531744a5152787761534d3973754e444637373651417a387057755153524d5553504564596e517333596e714174345855543163714d3336613941443659585148657631727176566b574e347a50504e43794743706457476a6d6459724875614341724031386164323033386461383336643535616138363331363466303830636165636563366333623566636139323564326165366132323930323564613066383366473045022100d0adc6cbf044ee240a51d0f974c531a548fcab73dd91bcb990dba810f48b9e1c022039e2dd47f453a05ddc1f3a93dc2054bb7b1e8853d757fbeab1e232421b5189426d6d6d6d75790c0000000000001976a91413042e21736ec6d72618231e1e409ab70b483eaa88ac22020000000000001976a91454ea6523917bd613868569def1e1855f2bd3636388acc8000000000000001976a9141750453c56b3906c417f8e3c6fa3e53b3954c04788ac611c0000000000001976a9140e780456680e08b1b9c7df33637b52d08725509a88ac00000000","proof":{"index":1,"txOrId":"e74979e5567b02ef77be345511ee0ee022ee9d01c76fc727c6bed7f0f7dd33be","targetType":"header","target":"000000209892addc82fd0301149d1442e66588127911e1d2ffdbdc84de03000000000000581e5022742eb7652246add1b487b198d5b060fc4fbe62a8d16648e0af56e0b4a34649647543041a3cd78238","nodes":["a2bb538ac2ef392c492eb3411b4844f7b185a164a204bf7092f9725f09e9c155","00fe7f636874cc38caf1d3bb6a8d0a2f71bdc5d959ecfdca2a42384e7158cca1","c366893e1078d48494b10219e40fdf3bbb7f0b029a1f51ac61004bbec128b6cc"]}}}},"44540e16ad2a2d3c9d224fade26e9434422584b4b163ec0e17c2039fed7392fa":{"rawTx":"01000000039bac7e2e5e77a31df0efd53df79a2fe437c4f48d22a12e0887dae91b395ba5b1040000006b48304502210093bb47ebebe7828e13f02580b2c8631df901cd001fb4eca94fe6b34b1b31b63202205f05cf4d9a373631b0f9a38b789d840e713b640edc0c451a50eef42a24ab6cec41210345bb626e60d47a1ce4b35a597538446e736e79bc21489e93281341c905c5616bffffffff548a32da787ff8b23e7af924f5d061749b81a328e66f024e42fe4cf5435f3e17040000006b483045022100f3db1ff9a8ccf9f7a12ca5301ec4f86f2bfe749f2bda8e1944869783bf29bfda02201266bf034458c3de1c50aeea6769d78726aafc4ad660c7ef84e49ea5980f73a9412102c807b41f97275c6042369f6ae3661cb17fd1d709dee1bd8687afb86418c90581ffffffff16136b6647c33e244cab23e112be353a22b767e0515e81b7ac80a56950c14744050000006a47304402206a8d2e8d33184493dcebcd4aa556430e0917268c33b37c80f249adc7c26444d402202758dba39cc5ec6bf31346b3cf40a557430809632190410b218f61b5876a5682412102ba4a37939f8e6216c9c0a92abc4e09733f00e61f127bd05b0dc852b8c0a196a6ffffffff050100000000000000fd5b012102ebec739c4b7ad1bd584e727b32126f5b6be87cd1e0e02a9cf23b5c34101593caac0354535022314c51744b4b4b376331544e33556352667370385371476a57747a47736b7a6533360174016a1344656661756c74206465736372697074696f6e013534585554645236756e50424165794e35794e7a7775695863775768614b666e517873366b666e63555431664c5477724e35644a6648345855543163714d3336613941443659585148657631727176566b574e347a50504e43794743706457476a6d6459724875614341724063653636306633656162623466376230343930373430646666666138613836613765643338346233633363316539636431393530613837623732306562663063463044022071017d5d9a0f647b125df711b737a57a046dbcfae390e7493cf431c228b3e14e0220134b96bd076b89066c7517ba577bec1174d3bdc70b4b86cf3b243337305ce0026d6d6d6d6dc50b0000000000001976a914514b478318b6f683fb9c8c6e950bee8c6136f7de88ac22020000000000001976a914930e5e93fb0cc0c352a86d2f6566e7b3e67a3e5188acc8000000000000001976a9141a6c8b74bb8f9152a6e2913b1c4702cdbffde7dc88acda090000000000001976a91425adcc3079f6bda0890e0d2c07aacc9f92f6b78088ac00000000","mapiResponses":[{"publicKey":"030d1fe5c1b560efe196ba40540ce9017c20daa9504c4c4cec6184fc702d9f274e","payload":"{\"apiVersion\":\"1.5.0\",\"timestamp\":\"2023-04-28T16:55:39.8480838Z\",\"txid\":\"44540e16ad2a2d3c9d224fade26e9434422584b4b163ec0e17c2039fed7392fa\",\"returnResult\":\"success\",\"resultDescription\":\"\",\"minerId\":\"030d1fe5c1b560efe196ba40540ce9017c20daa9504c4c4cec6184fc702d9f274e\",\"currentHighestBlockHash\":\"000000000000073638f165cee1fe2fa0c34f3657ce98b15ab493d11a3f5219ea\",\"currentHighestBlockHeight\":1549207,\"txSecondMempoolExpiry\":0,\"warnings\":[],\"failureRetryable\":false}","signature":"3044022041a1f187a7702d04b564887845a78a49f0248c26f1d0f4cca7fd9231ef5500480220522026f6005327b0ddef8e39fd536010e54d4d79e6c80d9cb85f85b069659357"}],"inputs":{"b1a55b391be9da87082ea1228df4c437e42f9af73dd5eff01da3775e2e7eac9b":{"rawTx":"0100000001bd96429c9e65466fbf68fcd164c297b728f3533328d1bdd8ee8857662bcc72f6040000006b483045022100ac4daa8e562a1de7334309b1e9c9f754f0efc5039d8c48fe28daab6b9040488f0220672587e4dcf27432894777f126a7df18f9f9c4822f06e9d0935046dc67b2c60f412103faeae54cb50049e6437fc7bc317e5cbd28c3809ae28e867e95d59d609d933f0dffffffff050100000000000000fd39012102ebec739c4b7ad1bd584e727b32126f5b6be87cd1e0e02a9cf23b5c34101593caac035453500174016a1344656661756c74206465736372697074696f6e013534585555334e7765347036666259394133764175754d5844506265536151686d4a58585964584a3857464c76583479487538793467345855543163714d3336613941443659585148657631727176566b574e347a50504e43794743706457476a6d6459724875614341724034366431366433353433386139613466623436363162376230326138303636616164343730396464653732633637373635336134643164623838303036323135473045022100e249b677421c5199f9ec0a338bb37885df4f6567cb63618f18adb4a0b69aff9602200e3b9deb05113ed82f52bd630ae48f10237e38260d41877e7e2c434fc28d97f26d6d6d6d75310c0000000000001976a91438a356eb29fdc035119712d05ad3676e10d9f3f188ac22020000000000001976a914b67c0e07d64949068b3319734c8969c27c90da2b88acc8000000000000001976a9142359e7292f08699bca2496a24b465bcfe3262a0a88ac000a0000000000001976a914801897139d037b84bc4cf8bd8335d696867ed53188ac00000000","proof":{"index":1,"txOrId":"b1a55b391be9da87082ea1228df4c437e42f9af73dd5eff01da3775e2e7eac9b","targetType":"header","target":"000000208fa7f444b63496a8a2267587ee19923f8a7ec9ad34edd0376202000000000000a3854aaae48a415104dbc184a4a191d14b023f3c91b20deb712a4963d5f52d29fa5949647429041a5dbe56c6","nodes":["958efb6f6830e58787349aece4431b53f980ff82e2155ca7756312d80354d4ff","cd5dadd17814f670e5d148da3ceb327bf1f1380062a7707ddb07e3ce833060d4","3ac98aedb60245e9d9e089c92ea0f9665f4a955a70168ee42614f44e8e232b26"]}},"173e5f43f54cfe424e026fe628a3819b7461d0f524f97a3eb2f87f78da328a54":{"rawTx":"0100000002573446ea5b84a9f0b4e3a39b17d761dc8b34e1db2fbf41cdf528156798f11786040000006a4730440220725c72da162e18acb2579b77bfd2aff6f5975aeabe1a6c241b3ab8e9bb1e926c0220417c9678608ec940476a43a7056ddd5cd9bfcee9355eea8fd01ed6cdbee81738412103b18401354796820863731cfdaea9c19ce0e7297f0972ccced18ca303a9d4c36cffffffff16136b6647c33e244cab23e112be353a22b767e0515e81b7ac80a56950c14744040000006b483045022100a89b2f9fd8f309f77da42826700571d71d40e0b742b727393137a1638e2d034c022037b7d65d959bca12ba15af6945abb9e4fc102c28ad9b79492b01dbd9b4795701412102de5e782c0ec3a1868a2c3be4a7b77458115e9f412c604b102cc653211615cabeffffffff050100000000000000fd38012102ebec739c4b7ad1bd584e727b32126f5b6be87cd1e0e02a9cf23b5c34101593caac035453500174016a1344656661756c74206465736372697074696f6e01353458555555797a5a3635577142644d6b5058386f34487938577252776f67764250787963756f6e4b4e6278385150734b63584e4d63345855543163714d3336613941443659585148657631727176566b574e347a50504e43794743706457476a6d6459724875614341724062376139323163336331393034653033353066323366363632353761303136643634386365666434323132323930393134383135346238383761656236316661463044022051ac221dc16c04bc73739aa9363c9be434515aa9a5c57fc1873d2c994dd5b59902206ca6cedeef28f42b7a430d26646feb54c9d7dde37888ec5df9e8dbe4dbba46df6d6d6d6d75380c0000000000001976a9141688cbd37a1f3c629d655f4f9a022196a6677e7188ac22020000000000001976a914158b04142a2642f6504e7715577c7d2d96b3d6cb88acc8000000000000001976a914d4eb70648fc01d7e17dd738ec7b65d218db929cf88acff020000000000001976a9149b1440962fc12fe70523db067ae408aae51f0c4e88ac00000000","proof":{"index":3,"txOrId":"173e5f43f54cfe424e026fe628a3819b7461d0f524f97a3eb2f87f78da328a54","targetType":"header","target":"00000020ddd323c8acf6c8101db7ad31c063832f7b0df1717c053aaf2a6403000000000021e260aac1b84c965dd7cebe64fa67fcc5a9f9467cc0d6628d3d630575f956a6e5084b648624081a5f333376","nodes":["905631ba5fc8d195426bb4eddce0eda097b42aa863c591c45ca55af2755983ee","79ba939b093f470c9c550b69625915194f4c64f799ea5ab2013a3efcb9112226","c82b88b9d1d6c81d273b739a193f4566923e1106908d820a417b801cf9cf9c08"]}},"4447c15069a580acb7815e51e067b7223a35be12e123ab4c243ec347666b1316":{"rawTx":"0100000002abd8d8ad015f12abe643ee9ba28f7e45a006aa020d77c140929b49cfa893cb6a050000006a47304402204449ee049638acf2e124e091f7d38f2059c0b6044deafc71555600c0b8edfe5402207f3036fba596d10a1d270d0b214e8836fac603956999d088c52fcfd0593940d94121026ce7b9fb83a21d41630ca3a08e3ab10a92aef890c6b6c3d2e5192a7d883c6c1bffffffff7ec8f3681e66512adb947b75ca27e7da968834fd1e4c0c964d0eb1d0551fc54e040000006b48304502210094d556935cd6b84eaf5ae84f6bb8ee2575d03b5c4d8296dc28c3e13e924768a6022038e2bf44de462abaa8a5fa001c01a11e0854c52492c51c83ca4f6210ea4865d64121035322edbb74a57705590a366e21eae3a8dd3e7f62827e5d3ba7dd1f94ccc18970ffffffff060100000000000000fd39012102ebec739c4b7ad1bd584e727b32126f5b6be87cd1e0e02a9cf23b5c34101593caac035453500174016a1344656661756c74206465736372697074696f6e01353458555558643378386165786f4242376a6e343534636947537551634e47355473674e6570416d4b366d3142386d32557859423644345855543163714d3336613941443659585148657631727176566b574e347a50504e43794743706457476a6d6459724875614341724062376633306333636637303939646232363531646337303133396566393364366664363034396238366463383961626363633033363333613633383334353434473045022100bc55b44ffa8931b49fe9eb512f5b7e6230e69919e0e2879582f262cfdc76a62b02206f50e655716aedafa153a66b2144e75d1a06fbe473e580f3f850db491a5c90d96d6d6d6d758e0c0000000000001976a9146c16dd04037b8c0bee7ef1b068e4e0424ee0624088ac22020000000000001976a914075478798fb662131c22e7fd1a3cd8a219ad38f588acc8000000000000001976a9149e32af434985f71b0a5861ef795728077f67fecd88ac910b0000000000001976a91422f9cbc19488e0ca76a5fc2e237ca3b67cb77d6788acf80b0000000000001976a9142e1a314ef6d6ce2d99a85bb1b30b7658292d03d288ac00000000","proof":{"index":2,"txOrId":"4447c15069a580acb7815e51e067b7223a35be12e123ab4c243ec347666b1316","targetType":"header","target":"00000020c2f58795a264c152c4a412bd31ed8a050023f616fa305ae66a04000000000000bea06440dd777028d068e8d77003fe0f20dfd1fbc7e944650e0bde8c07215d0a44ea4a643ebd071a56c2bde8","nodes":["b3604bc613869bed5c154f1c3568f7682f100f392050783884ba5854415bd333","8314b7bd443c1d9c4e7cc229e605ae0f0ce4ccae9edba53ded58ffa8a4387416","f0da338eebc52fefbc2c5de9ee857579b5a184c988196f3b24f3b159745b7533"]}}}}},"mapiResponses":[{"publicKey":"030d1fe5c1b560efe196ba40540ce9017c20daa9504c4c4cec6184fc702d9f274e","payload":"{\"apiVersion\":\"1.5.0\",\"timestamp\":\"2023-04-28T17:17:25.0588682Z\",\"txid\":\"187a6741f40d2a11036a2af25374cd35129e3b8cef6d506c29ed4c2a08e2d17d\",\"returnResult\":\"success\",\"resultDescription\":\"\",\"minerId\":\"030d1fe5c1b560efe196ba40540ce9017c20daa9504c4c4cec6184fc702d9f274e\",\"currentHighestBlockHash\":\"00000000000007d0f9d9f9460b299f43c71d09865ecf2e15215fec14ce6b353d\",\"currentHighestBlockHeight\":1549209,\"txSecondMempoolExpiry\":0,\"warnings\":[],\"failureRetryable\":false}","signature":"30440220206e1d809fca9179415fabfe3cb196c2eebc8bb185b8ac59554440b4ee98dd85022000dcc895a20a3d1a90ad82545bdb6b31e8e1413b468893a7726293aafafe1b30"}],"rawTx":"0100000002dac900db40fee454d3514262fd823a3bf6e0aca7a29871e30e0524901f829ff2020000006b483045022100a380bd0159ff6046fe9f9d8f35178d237198dbef829625362fcf7ab6e8fad32e0220487b98b1fcbe1205ef7546a03fbb3c5c4ecc13e9d341952925a26a0306e1299a4121033745290a86b70869e180bceb4cd22a355af64d3848f8b53a30aaef294dbe62c1fffffffffa9273ed9f03c2170eec63b1b484254234946ee2ad4f229d3c2d2aad160e5444040000006b483045022100813bd9e0f6ca7770c23f8a10a9ef7ff7ad4a196b09f2ef8a9ab1d533a78b26090220049c498aeefc85507b10c8e7eefd9a4a41906d4946c0d84f07602e252ce5b7414121020b8007ab918eddbe791514cde739dd4b4f84379dd61bc7998e14b8b79fe8e3c5ffffffff060100000000000000fd5c012102ebec739c4b7ad1bd584e727b32126f5b6be87cd1e0e02a9cf23b5c34101593caac0354535022314c51744b4b4b376331544e33556352667370385371476a57747a47736b7a6533360174016a1344656661756c74206465736372697074696f6e0135345855556f6433545a4d325a6b744747457a4e47544c5254655556487936724a4a36466573583842434e79784b4145566952455476345855543163714d3336613941443659585148657631727176566b574e347a50504e43794743706457476a6d6459724875614341724035393134313736653931306563643736313262356564613438666631643165623833386231653030366166363765396634613230376232323665323730363037473045022100826cf22bce0c9129644c3430254741b26b27203e97851c12e869d7081b754f1202202869fd12a6341a62962506c0fa9be41fb92e38daaa277634a73f2e60c42182806d6d6d6d6def0b0000000000001976a914ca52df327d56604a9f4dabf78ab043465cb79d5288ac22020000000000001976a914e9322649c951d1f8441a37bd493da6d0e5667a6988acc8000000000000001976a9140cbd42adbaef15083a19b0ffbce1f67c57146d4d88ac7c040000000000001976a914f2f87e460c44fec74e2b3691f9860cb327bde55e88ac78040000000000001976a914e5eecb9a69c389d3efff7563d9303fe9c470483c88ac00000000"},"6acb93a8cf499b9240c1770d02aa06a0457e8fa29bee43e6ab125f01add8d8ab":{"proof":{"index":4,"txOrId":"6acb93a8cf499b9240c1770d02aa06a0457e8fa29bee43e6ab125f01add8d8ab","targetType":"header","target":"000000204a0acf7820135d317d08ab97f5a79334e8cf3052fad49764ef0000000000000067c57ae233063c3321fd6184c07cfeae2ee0a15a2424769147577976f287aba58dd34a64ffff001d85c2b68d","nodes":["1741e22b76d0426229e23358943da1f55a76aabb133b3c70ab4f5221128e7606","*","49746ddf390c20c5cb0030a81945c437bbe3786d08c380e4c9ea9b0a6d088bde"]},"rawTx":"0100000001cc0da7bbe30c02d78b72bd779bd2eb72e110c4a9800708b87902a6ad6c477360040000006a473044022030df3b60dac304e0b76bc683efaa268bdc599d62cc7fb37141716fe8999e6f1502204e53609cfa23b2e17d0af71231d2b9bdeeec00dceb9bd3372b69191fe16ba3bd41210382973024ca78ecf2ac505bf51fd02a130103c86eecae1aadff4d1a5de53112c1ffffffff080100000000000000fd39012102ebec739c4b7ad1bd584e727b32126f5b6be87cd1e0e02a9cf23b5c34101593caac035453500174016a1344656661756c74206465736372697074696f6e0135345855546e6f4855353872687a72637a4e546176516b714e455576765a6432663566516e624147356b376b6d5278423456794a5838345855543163714d3336613941443659585148657631727176566b574e347a50504e43794743706457476a6d6459724875614341724064613030346331333134306462326436613532333761386535376633356437396263336539643133333165356233643936383030623139356537623338653530473045022100e2099659a2ecef1e11ee21f8df78a3bd893b591757c96278c9b21c00b9e842120220699ecee344de0dd75fc55c420caa03ee6574fee98d7ae447d6665f2b751612c76d6d6d6d755f0c0000000000001976a9145ce1a5e4ccbfa34b8d7056e44612d84b1662764688ac22020000000000001976a9143b33687fdff7a9a0087bd6f2c28400fce46aad5788acc8000000000000001976a91471f9cfdaae0b85befbae00bbcf4f59e325307d0f88acd65a0000000000001976a914020d787b9163a5d4e041711d22022b0be8ba369788acad240000000000001976a91439aa3b79f09ca79ed9fc1ad5be32ed00d58043a388ac2f110000000000001976a914d9e774cf0dc1dcf0c57264df439b452b16d4b87488ac6d050000000000001976a91461992b2387f0f21c71a29b835c1b22e0b38958d788ac00000000"}},"mapiResponses":[{"payload":"{\"apiVersion\":\"1.5.0\",\"timestamp\":\"2023-04-28T17:56:41.1255182Z\",\"txid\":\"9f2ab17d9c97f3b5d84527eb4070d75813a4e00032fc2012ed22e0b8be4afb0c\",\"returnResult\":\"success\",\"resultDescription\":\"\",\"minerId\":\"030d1fe5c1b560efe196ba40540ce9017c20daa9504c4c4cec6184fc702d9f274e\",\"currentHighestBlockHash\":\"000000000000051d95af6ea1a34f99b149976b8a5489965abcaa6fc7e9d5986b\",\"currentHighestBlockHeight\":1549216,\"txSecondMempoolExpiry\":0,\"warnings\":[],\"failureRetryable\":false}","publicKey":"030d1fe5c1b560efe196ba40540ce9017c20daa9504c4c4cec6184fc702d9f274e","signature":"3044022052118aa9cd3b70017d14c1a3d882d0de36e4d567dce755f52b10041a33efd55102206c607191fa255db3f90dbe9138d398c50240bccd022240243b9526eed6c91287"}],"txid":"9f2ab17d9c97f3b5d84527eb4070d75813a4e00032fc2012ed22e0b8be4afb0c"}

  await new Authrite().request(
    `${constants.confederacyURL}/submit`,
    {
      method: 'POST',
      body: {
        ...payment,
        topics: [constants.tempoTopic]
      }
    }
  )

  // Pay and upload the files to nanostore
  await submitPaymentProof({ fileUploadInfo, payment })

  // Export encryption key to store on the keyServer
  await publishKey({ key: fileUploadInfo.encryptionKey, songURL: fileUploadInfo.songURL })
  console.log("done")
  return true
}
